# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  connect-open-vpn:
    runs-on: ubuntu-latest
    steps:
      - name: Install OpenVPN
        run: sudo apt-get --assume-yes --no-install-recommends install openvpn

      - name: Setup VPN config
        run: |
          echo "${{ secrets.CA_CRT }}" > ca.crt
          echo "${{ secrets.USER_CRT }}" > user.crt
          echo "${{ secrets.USER_KEY }}" > user.key
          echo "${{ secrets.TLS_KEY }}" > tls.key          

      - name: Connect VPN
        run: |
            git remote set-url origin git@github.com:Obo23/Prueba_VPN2.git
            sudo openvpn --config Prueba_VPN/vpn/config.ovpn 

      - name: Wait for a VPN connection
        timeout-minutes: 2
        run: until ping -c1 your-server-address; do sleep 2; done

      - name: Deploy
        run: echo {"hello"}
  
      - name: Kill VPN connection
        if: always()
        run: sudo killall openvpn   